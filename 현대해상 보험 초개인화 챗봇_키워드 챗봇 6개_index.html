<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í˜„ëŒ€í•´ìƒ í•˜ì´ì¼€ì–´ë´‡</title>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Pretendard:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #F9FAFB;
      color: #333;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .header {
      text-align: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .header img {
      height: 40px;
      margin-bottom: 10px;
    }
    
    .header h1 {
      color: #005BAC;
      margin: 0;
      font-size: 24px;
    }
    
    .chat-container {
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      margin: 20px 0;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }
    
    .message.bot {
      flex-direction: row;
    }
    
    .message.user {
      flex-direction: row-reverse;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .bubble {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 70%;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }
    
    .bubble.bot {
      background-color: #e1f5fe;
      color: #003c8f;
      text-align: left;
    }
    
    .bubble.user {
      background-color: #c8e6c9;
      color: #1b5e20;
      text-align: right;
      margin-left: auto;
    }
    
    .bubble.bot::after {
      content: '';
      position: absolute;
      top: 10px;
      left: -8px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid #e1f5fe;
    }
    
    .bubble.user::after {
      content: '';
      position: absolute;
      top: 10px;
      right: -8px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 8px solid #c8e6c9;
    }
    
    .input-area {
      display: flex;
      margin-top: 20px;
      justify-content: center;
      position: relative;
    }
    
    #user-input {
      flex: 1;
      max-width: 85%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
    }
    
    #user-input:focus {
      border-color: #005BAC;
      box-shadow: 0 0 5px rgba(0, 91, 172, 0.3);
    }
    
    button {
      background-color: #005BAC;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    
    button:hover {
      background-color: #004d8c;
    }
    
    button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .profile-form {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #E5E7EB;
      border-radius: 4px;
    }
    
    .form-group input:focus, .form-group select:focus {
      border-color: #005BAC;
      outline: none;
    }
    
    .form-error {
      color: #D32F2F;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    .welcome-screen {
      text-align: center;
      padding: 30px 0;
    }
    
    .welcome-screen img {
      width: 150px;
      margin-bottom: 20px;
    }
    
    .welcome-screen h2 {
      color: #005BAC;
      margin-bottom: 20px;
    }
    
    .welcome-screen p {
      margin-bottom: 30px;
      color: #666;
    }
    
    .start-button {
      background-color: #005BAC;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .start-button:hover {
      background-color: #004d8c;
    }
    
    .start-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .hidden {
      display: none;
    }
    
    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .quick-button {
      background-color: #F0F8FF;
      border: 1px solid #005BAC;
      color: #005BAC;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .quick-button:hover {
      background-color: #005BAC;
      color: white;
    }
    
    .quick-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .category-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .category-button {
      background-color: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .category-button:hover {
      border-color: #005BAC;
      box-shadow: 0 2px 8px rgba(0, 91, 172, 0.2);
    }
    
    .category-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .category-icon {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .category-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .category-desc {
      font-size: 12px;
      color: #666;
    }
    
    .typing-indicator {
      display: inline-block;
      padding: 8px 15px;
      background-color: #e1f5fe;
      border-radius: 12px;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #005BAC;
      border-radius: 50%;
      animation: typing 1s infinite;
      margin: 0 2px;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    #disclaimer {
      font-size: 10px;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
    
    .error-message {
      color: #D32F2F;
      text-align: center;
      margin: 10px 0;
    }
    
    .loading-indicator {
      text-align: center;
      margin: 10px 0;
      color: #005BAC;
      font-size: 14px;
    }
    
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .autocomplete-suggestion {
      padding: 10px;
      cursor: pointer;
      color: #333;
    }
    
    .autocomplete-suggestion:hover {
      background-color: #F0F8FF;
    }
    
    .feedback-button, .save-log-button {
      background-color: #F0F8FF;
      border: 1px solid #005BAC;
      color: #005BAC;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      margin-right: 10px;
      display: inline-block;
    }
    
    .feedback-button:hover, .save-log-button:hover {
      background-color: #005BAC;
      color: white;
    }
    
    .feedback-button:focus, .save-log-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="welcome-screen" class="welcome-screen">
      <img src="https://www.hi.co.kr/images/main/logo.png" alt="í˜„ëŒ€í•´ìƒ ë¡œê³ " role="img" aria-label="í˜„ëŒ€í•´ìƒ ë¡œê³ ">
      <h2>í˜„ëŒ€í•´ìƒ í•˜ì´ì¼€ì–´(Hi-Care) ë´‡</h2>
      <p>ê³ ê°ë‹˜ì˜ ìƒí™©ì— ë§ëŠ” ë§ì¶¤í˜• ë³´í—˜ ìƒë‹´ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</p>
      <button id="start-button" class="start-button" role="button" aria-label="ìƒë‹´ ì‹œì‘í•˜ê¸°">ìƒë‹´ ì‹œì‘í•˜ê¸°</button>
    </div>
    
    <!-- í”„ë¡œí•„ ì…ë ¥ í™”ë©´ -->
    <div id="profile-screen" class="hidden" role="form" aria-label="ê³ ê° ì •ë³´ ì…ë ¥ í¼">
      <div class="header">
        <img src="https://www.hi.co.kr/images/main/logo.png" alt="í˜„ëŒ€í•´ìƒ ë¡œê³ " role="img" aria-label="í˜„ëŒ€í•´ìƒ ë¡œê³ ">
        <h1>í•˜ì´ì¼€ì–´(Hi-Care)ë´‡ê³¼ í•¨ê»˜í•˜ëŠ” ë§ì¶¤í˜• ìƒë‹´</h1>
      </div>
      
      <div class="profile-form">
        <h2>ê³ ê° ì •ë³´ ì…ë ¥</h2>
        <p>ë” ì •í™•í•œ ë§ì¶¤í˜• ìƒë‹´ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <div class="form-group">
          <label for="name">ì´ë¦„</label>
          <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" aria-required="true">
          <div id="name-error" class="form-error">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (2~50ì).</div>
        </div>
        
        <div class="form-group">
          <label for="gender">ì„±ë³„</label>
          <select id="gender" aria-required="true">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë‚¨ì„±">ë‚¨ì„±</option>
            <option value="ì—¬ì„±">ì—¬ì„±</option>
          </select>
          <div id="gender-error" class="form-error">ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>
        
        <div class="form-group">
          <label for="age">ì—°ë ¹</label>
          <input type="number" id="age" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" min="18" max="100" aria-required="true">
          <div id="age-error" class="form-error">18ì„¸ ì´ìƒ 100ì„¸ ì´í•˜ì˜ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>
        
        <div class="form-group">
          <label for="occupation">ì§ì—…</label>
          <select id="occupation" aria-required="true">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì‚¬ë¬´ì§">ì‚¬ë¬´ì§</option>
            <option value="ì „ë¬¸ì§">ì „ë¬¸ì§</option>
            <option value="ìì˜ì—…">ìì˜ì—…</option>
            <option value="í•™ìƒ">í•™ìƒ</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <div id="occupation-error" class="form-error">ì§ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>
        
        <div class="form-group">
          <label for="income">ì—°ì†Œë“ (ë§Œ ì›)</label>
          <select id="income">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="100">3000ì´í•˜</option>
            <option value="300">3000ì´ìƒ ~ 5000ë¯¸ë§Œ</option>
            <option value="500">5000ì´ìƒ ~ 7000ë¯¸ë§Œ</option>
            <option value="1000">7000ì´ìƒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="insurance-experience">ë³´í—˜ ê°€ì… ê²½í—˜</label>
          <select id="insurance-experience">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì—†ìŒ">ì—†ìŒ</option>
            <option value="ìë™ì°¨ë³´í—˜ë§Œ">ìë™ì°¨ë³´í—˜ë§Œ</option>
            <option value="ì‹¤ì†ë³´í—˜ë§Œ">ì‹¤ì†ë³´í—˜ë§Œ</option>
            <option value="ë‹¤ì–‘í•œ ë³´í—˜ ê°€ì…">ë‹¤ì–‘í•œ ë³´í—˜ ê°€ì…</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="interest">ê´€ì‹¬ ìˆëŠ” ë³´í—˜ ìƒí’ˆ</label>
          <select id="interest">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ìë™ì°¨ë³´í—˜">ìë™ì°¨ë³´í—˜</option>
            <option value="ì‹¤ì†ë³´í—˜">ì‹¤ì†ë³´í—˜</option>
            <option value="ë¯¸ì •/ìƒë‹´í•„ìš”">ë¯¸ì •/ìƒë‹´í•„ìš”</option>
          </select>
        </div>
        
        <button id="submit-profile" role="button" aria-label="ìƒë‹´ ì‹œì‘í•˜ê¸°">ìƒë‹´ ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>
    
    <!-- ì±—ë´‡ í™”ë©´ -->
    <div id="chat-screen" class="hidden" role="region" aria-label="ì±—ë´‡ ëŒ€í™” í™”ë©´">
      <div class="header">
        <img src="https://www.hi.co.kr/images/main/logo.png" alt="í˜„ëŒ€í•´ìƒ ë¡œê³ " role="img" aria-label="í˜„ëŒ€í•´ìƒ ë¡œê³ ">
        <h1>í•˜ì´ì¼€ì–´(Hi-Care) ë´‡</h1>
      </div>
      
      <div id="chat-container" class="chat-container" role="log" aria-live="polite">
        <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        <div id="loading-indicator" class="loading-indicator hidden">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
      
      <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
      <div id="category-buttons" class="category-buttons" role="navigation" aria-label="ë³´í—˜ ì¹´í…Œê³ ë¦¬ ì„ íƒ">
        <div class="category-button" data-category="ìë™ì°¨ë³´í—˜" role="button" tabindex="0" aria-label="ìë™ì°¨ë³´í—˜: ìë™ì°¨/ì´ë¥œì°¨/ìš´ì „ì">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_car.png');"></div>
          <div class="category-title">ìë™ì°¨ë³´í—˜</div>
          <div class="category-desc">ìë™ì°¨/ì´ë¥œì°¨/ìš´ì „ì</div>
        </div>
        <div class="category-button" data-category="ì‹¤ì†ì˜ë£Œë³´í—˜" role="button" tabindex="0" aria-label="ì‹¤ì†ì˜ë£Œë³´í—˜: ì‹¤ì†/ê±´ê°•">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_health.png');"></div>
          <div class="category-title">ì‹¤ì†ì˜ë£Œë³´í—˜</div>
          <div class="category-desc">ì‹¤ì†/ê±´ê°•</div>
        </div>
        <div class="category-button" data-category="ìƒë‹´ì˜ˆì•½" role="button" tabindex="0" aria-label="ìƒë‹´ì˜ˆì•½: ì „í™”/í™”ìƒ ìƒë‹´">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_consult.png');"></div>
          <div class="category-title">ìƒë‹´ì˜ˆì•½</div>
          <div class="category-desc">ì „í™”/í™”ìƒ ìƒë‹´</div>
        </div>
        <div class="category-button" data-category="ë³´í—˜ë£Œê³„ì‚°" role="button" tabindex="0" aria-label="ë³´í—˜ë£Œê³„ì‚°: ê²¬ì  í™•ì¸">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_calculate.png');"></div>
          <div class="category-title">ë³´í—˜ë£Œê³„ì‚°</div>
          <div class="category-desc">ê²¬ì  í™•ì¸</div>
        </div>
        <div class="category-button" data-category="ì¶”ì²œìƒí’ˆ" role="button" tabindex="0" aria-label="ì¶”ì²œìƒí’ˆ: ë§ì¶¤ ì¶”ì²œ">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_recommend.png');"></div>
          <div class="category-title">ì¶”ì²œìƒí’ˆ</div>
          <div class="category-desc">ë§ì¶¤ ì¶”ì²œ</div>
        </div>
        <div class="category-button" data-category="ì§€ì ì•ˆë‚´" role="button" tabindex="0" aria-label="ì§€ì ì•ˆë‚´: ìµœê·¼ ì§€ì ">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_location.png');"></div>
          <div class="category-title">ì§€ì ì•ˆë‚´</div>
          <div class="category-desc">ìµœê·¼ ì§€ì </div>
        </div>
      </div>
      
      <!-- í€µë²„íŠ¼ ì˜ì—­ -->
      <div id="quick-buttons" class="quick-buttons" role="navigation" aria-label="ë¹ ë¥¸ ì‘ë‹µ ë²„íŠ¼">
        <!-- í€µë²„íŠ¼ì€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="input-area">
        <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." role="textbox" aria-label="ë©”ì‹œì§€ ì…ë ¥" autocomplete="off">
        <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
        <button id="send-button" role="button" aria-label="ë©”ì‹œì§€ ë³´ë‚´ê¸°">ë³´ë‚´ê¸°</button>
      </div>
      
      <button id="feedback-button" class="feedback-button" role="button" aria-label="í”¼ë“œë°± ì œê³µ">í”¼ë“œë°± ì œê³µ</button>
      <button id="save-log-button" class="save-log-button" role="button" aria-label="ëŒ€í™” ë¡œê·¸ ì €ì¥">ëŒ€í™” ë¡œê·¸ ì €ì¥</button>
    </div>
    
    <div id="disclaimer">ë²•ì  êµ¬ì†ë ¥ ì—†ëŠ” ì •ë³´ë¡œ, ìƒë‹´ì› í™•ì¸ ê¶Œì¥</div>
  </div>

  <script>
    // Initializing user profile
    let userProfile = {
      name: "",
      gender: "",
      age: 0,
      occupation: "",
      income: 0,
      insuranceExperience: "",
      interest: ""
    };
    
    // Defining insurance products
    const insuranceProducts = {
      "ìë™ì°¨ë³´í—˜": {
        description: "ìë™ì°¨ ì‚¬ê³ ë¡œ ì¸í•œ ì†í•´ë¥¼ ë³´ìƒí•˜ëŠ” ìƒí’ˆì…ë‹ˆë‹¤.",
        subCategories: ["ìë™ì°¨ë³´í—˜", "ì´ë¥œì°¨ë³´í—˜", "ìš´ì „ìë³´í—˜"],
        quickButtons: ["ìë™ì°¨ë³´í—˜ ê²¬ì ", "ì´ë¥œì°¨ë³´í—˜ ì•ˆë‚´", "ìš´ì „ìë³´í—˜ ìƒë‹´"]
      },
      "ì‹¤ì†ì˜ë£Œë³´í—˜": {
        description: "ì˜ë£Œë¹„ë¥¼ ë³´ì¥í•˜ëŠ” ì‹¤ì†ì˜ë£Œë³´í—˜ ìƒí’ˆì…ë‹ˆë‹¤.",
        subCategories: ["ì‹¤ì†ë³´í—˜", "ê±´ê°•ë³´í—˜"],
        quickButtons: ["ì‹¤ì†ë³´í—˜ ì•ˆë‚´", "ê±´ê°•ë³´í—˜ ìƒë‹´"]
      },
      "ìƒë‹´ì˜ˆì•½": {
        description: "ì „í™” ë˜ëŠ” í™”ìƒ ìƒë‹´ ì˜ˆì•½ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.",
        subCategories: ["ì „í™” ìƒë‹´", "í™”ìƒ ìƒë‹´"],
        quickButtons: ["ì „í™” ìƒë‹´ ì˜ˆì•½", "í™”ìƒ ìƒë‹´ ì˜ˆì•½"]
      },
      "ë³´í—˜ë£Œê³„ì‚°": {
        description: "ë³´í—˜ë£Œ ê²¬ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        subCategories: ["ìë™ì°¨ë³´í—˜ ê²¬ì ", "ì‹¤ì†ë³´í—˜ ê²¬ì "],
        quickButtons: ["ìë™ì°¨ë³´í—˜ ê²¬ì ", "ì‹¤ì†ë³´í—˜ ê²¬ì "]
      },
      "ì¶”ì²œìƒí’ˆ": {
        description: "ê³ ê°ë‹˜ê»˜ ë§ëŠ” ë³´í—˜ ìƒí’ˆì„ ì¶”ì²œí•©ë‹ˆë‹¤.",
        subCategories: ["ë§ì¶¤ ì¶”ì²œ", "ê°€ì¡± ë³´í—˜"],
        quickButtons: ["ë§ì¶¤ ì¶”ì²œ ë°›ê¸°", "ê°€ì¡± ë³´í—˜ ì•ˆë‚´"]
      },
      "ì§€ì ì•ˆë‚´": {
        description: "ê°€ê¹Œìš´ ì§€ì  ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
        subCategories: ["ì§€ì  ìœ„ì¹˜", "ë°©ë¬¸ ì˜ˆì•½"],
        quickButtons: ["ì§€ì  ìœ„ì¹˜ ì•ˆë‚´", "ë°©ë¬¸ ì˜ˆì•½"]
      }
    };
    
    // Storing persona data
    let personaData = [];
    
    // Autocomplete suggestions
    const autocompleteSuggestions = [
      "ìë™ì°¨ë³´í—˜ ê²¬ì ",
      "ì‹¤ì†ë³´í—˜ ì•ˆë‚´",
      "ë§ì¶¤ ì¶”ì²œ ë°›ê¸°",
      "ìƒë‹´ì‚¬ ì—°ê²°",
      "ë³´í—˜ë£Œ ê³„ì‚°",
      "ì§€ì  ìœ„ì¹˜",
      "ìš´ì „ìë³´í—˜ ìƒë‹´",
      "ê±´ê°•ë³´í—˜ ìƒë‹´"
    ];
    
    // Loading and parsing persona CSV
    function loadPersonaData() {
      const loadingIndicator = document.getElementById('loading-indicator');
      loadingIndicator.classList.remove('hidden');
      Papa.parse(loadFileData("ê³ ê°í˜ë¥´ì†Œë‚˜.csv"), {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        transformHeader: header => header.trim().replace(/^"|"$/g, ''),
        transform: (value, header) => {
          let cleaned = value.trim().replace(/^"|"$/g, '');
          return cleaned;
        },
        complete: results => {
          personaData = results.data.map(row => ({
            id: row["ID"],
            name: row["í˜ë¥´ì†Œë‚˜ëª…"],
            ageGroup: row["ì—°ë ¹ëŒ€"],
            gender: row["ì„±ë³„"],
            occupation: row["ì§ì—…"],
            residence: row["ê±°ì£¼ì§€"],
            vehicle: row["ì°¨ëŸ‰ ì •ë³´"],
            drivingExperience: row["ìš´ì „ ê²½ë ¥"],
            family: row["ê°€ì¡± êµ¬ì„±"],
            currentProduct: row["í˜„ì¬ ê°€ì… ìƒí’ˆ (í˜„ëŒ€í•´ìƒ)"],
            specialClauses: row["ì£¼ìš” íŠ¹ì•½ (í˜„ëŒ€í•´ìƒ ë‹¤ì´ë ‰íŠ¸ ê¸°ì¤€)"],
            monthlyPremium: parseFloat(row["ì›” í‰ê·  ë³´í—˜ë£Œ (ì¶”ì •)"]?.replace("ë§Œì›", "") || 0),
            drivingPattern: row["ì£¼ìš” ì£¼í–‰ íŒ¨í„´"],
            drivingHabit: row["ìš´ì „ ìŠµê´€"],
            infoChannel: row["ì •ë³´ íƒìƒ‰ ì±„ë„"],
            coreNeeds: row["í•µì‹¬ ë‹ˆì¦ˆ"],
            painPoints: row["í˜ì¸ í¬ì¸íŠ¸"],
            preferenceReason: row["í˜„ëŒ€í•´ìƒ ë‹¤ì´ë ‰íŠ¸ ì„ í˜¸ ì´ìœ /ê¸°ëŒ€"]
          }));
          loadingIndicator.classList.add('hidden');
        },
        error: err => {
          console.error("CSV parsing error:", err);
          loadingIndicator.classList.add('hidden');
          addBotMessage("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      });
    }
    
    // Matching user to closest persona
    function findMatchingPersona(profile) {
      if (!profile || !profile.age || !profile.gender || !profile.occupation) {
        return null;
      }
      
      const age = parseInt(profile.age);
      const ageGroup = age >= 20 && age < 30 ? "20ëŒ€" : age >= 30 && age < 50 ? "30ëŒ€" : "40ëŒ€";
      let bestMatch = null;
      let highestScore = 0;
      
      personaData.forEach(persona => {
        let score = 0;
        if (persona.ageGroup === ageGroup) score += 3;
        if (persona.gender === profile.gender) score += 2;
        if (persona.occupation.toLowerCase().includes(profile.occupation.toLowerCase())) score += 2;
        if (profile.interest === "ìë™ì°¨ë³´í—˜" && persona.currentProduct.includes("ìë™ì°¨ë³´í—˜")) score += 1;
        if (profile.interest === "ì‹¤ì†ë³´í—˜" && !persona.currentProduct.includes("ìë™ì°¨ë³´í—˜")) score += 1;
        
        if (score > highestScore) {
          highestScore = score;
          bestMatch = persona;
        }
      });
      
      return bestMatch;
    }
    
    // Generating personalized recommendation
    function generateRecommendation(persona) {
      if (!persona) {
        return "ê³ ê°ë‹˜ì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì í•©í•œ ë³´í—˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë” ìì„¸í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
      }
      
      return `ê³ ê°ë‹˜ê»˜ ì¶”ì²œë“œë¦¬ëŠ” ìƒí’ˆì€ ${persona.currentProduct}ì…ë‹ˆë‹¤.  
ì£¼ìš” íŠ¹ì•½: ${persona.specialClauses}  
ì¶”ì • ì›” ë³´í—˜ë£Œ: ${persona.monthlyPremium}ë§Œì›  
ê³ ê°ë‹˜ì˜ ìš´ì „ íŒ¨í„´(${persona.drivingPattern})ê³¼ ë‹ˆì¦ˆ(${persona.coreNeeds})ì— ì í•©í•˜ë©°, ${persona.preferenceReason}ì„ ì œê³µí•©ë‹ˆë‹¤.`;
    }
    
    // Mock function to simulate file loading
    function loadFileData(fileName) {
      return "ID,í˜ë¥´ì†Œë‚˜ëª…,ì—°ë ¹ëŒ€,ì„±ë³„,ì§ì—…,ê±°ì£¼ì§€,ì°¨ëŸ‰ ì •ë³´,ìš´ì „ ê²½ë ¥,ê°€ì¡± êµ¬ì„±,í˜„ì¬ ê°€ì… ìƒí’ˆ (í˜„ëŒ€í•´ìƒ),ì£¼ìš” íŠ¹ì•½ (í˜„ëŒ€í•´ìƒ ë‹¤ì´ë ‰íŠ¸ ê¸°ì¤€),ì›” í‰ê·  ë³´í—˜ë£Œ (ì¶”ì •),ì£¼ìš” ì£¼í–‰ íŒ¨í„´,ìš´ì „ ìŠµê´€,ì •ë³´ íƒìƒ‰ ì±„ë„,í•µì‹¬ ë‹ˆì¦ˆ,í˜ì¸ í¬ì¸íŠ¸,í˜„ëŒ€í•´ìƒ ë‹¤ì´ë ‰íŠ¸ ì„ í˜¸ ì´ìœ /ê¸°ëŒ€\n1,ê¹€ì§€ì˜,30ëŒ€,ì—¬ì„±,ì‚¬ë¬´ì§,ì„œìš¸,ì†Œí˜• SUV,5ë…„,2ì¸ ê°€ì¡±,ìë™ì°¨ë³´í—˜,ëŒ€ì¸ë°°ìƒ/ëŒ€ë¬¼ë°°ìƒ,5ë§Œì›,ë„ì‹¬ ì£¼í–‰,ì•ˆì „ìš´ì „,ì˜¨ë¼ì¸,í•©ë¦¬ì ì¸ ë³´í—˜ë£Œ,ë³µì¡í•œ ê°€ì… ì ˆì°¨,ê°„í¸í•œ ì˜¨ë¼ì¸ ê°€ì…";
    }
    
    // Check for Google Apps Script environment
    function isGoogleScriptAvailable() {
      return typeof google !== 'undefined' && google.script && google.script.run;
    }
    
    // Save chat history to localStorage
    function saveChatHistory(messages) {
      localStorage.setItem('hicareBotChat', JSON.stringify(messages));
    }
    
    // Load chat history from localStorage
    function loadChatHistory() {
      const saved = localStorage.getItem('hicareBotChat');
      return saved ? JSON.parse(saved) : [];
    }
    
    // Save chat log to a text file
    function saveChatLogToFile() {
      const chatHistory = loadChatHistory();
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `hicarebot_chatlog_${timestamp}.txt`;
      let logContent = `í˜„ëŒ€í•´ìƒ í•˜ì´ì¼€ì–´(Hi-Care) ë´‡ ëŒ€í™” ë¡œê·¸\nìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}\nì‚¬ìš©ì: ${userProfile.name || 'ìµëª…'}\n\n`;
      
      chatHistory.forEach(msg => {
        const sender = msg.type === 'bot' ? 'í•˜ì´ì¼€ì–´ë´‡' : 'ì‚¬ìš©ì';
        logContent += `[${sender}]: ${msg.text}\n`;
      });
      
      const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      addBotMessage("ëŒ€í™” ë¡œê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    
    // Validate profile form
    function validateProfileForm() {
      let isValid = true;
      const name = document.getElementById('name').value.trim();
      const gender = document.getElementById('gender').value;
      const age = parseInt(document.getElementById('age').value);
      const occupation = document.getElementById('occupation').value;
      
      const nameError = document.getElementById('name-error');
      const genderError = document.getElementById('gender-error');
      const ageError = document.getElementById('age-error');
      const occupationError = document.getElementById('occupation-error');
      
      nameError.style.display = 'none';
      genderError.style.display = 'none';
      ageError.style.display = 'none';
      occupationError.style.display = 'none';
      
      if (!name || name.length < 2 || name.length > 50) {
        nameError.style.display = 'block';
        isValid = false;
      }
      
      if (!gender) {
        genderError.style.display = 'block';
        isValid = false;
      }
      
      if (isNaN(age) || age < 18 || age > 100) {
        ageError.style.display = 'block';
        isValid = false;
      }
      
      if (!occupation) {
        occupationError.style.display = 'block';
        isValid = false;
      }
      
      return isValid;
    }
    
    // Show autocomplete suggestions
    function showAutocompleteSuggestions(input) {
      const suggestionsContainer = document.getElementById('autocomplete-suggestions');
      suggestionsContainer.innerHTML = '';
      if (!input) {
        suggestionsContainer.style.display = 'none';
        return;
      }
      
      const filteredSuggestions = autocompleteSuggestions.filter(s =>
        s.toLowerCase().includes(input.toLowerCase())
      );
      
      if (filteredSuggestions.length > 0) {
        filteredSuggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'autocomplete-suggestion';
          div.textContent = suggestion;
          div.setAttribute('role', 'option');
          div.setAttribute('tabindex', '0');
          div.addEventListener('click', () => {
            document.getElementById('user-input').value = suggestion;
            suggestionsContainer.style.display = 'none';
            sendMessage();
          });
          div.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              document.getElementById('user-input').value = suggestion;
              suggestionsContainer.style.display = 'none';
              sendMessage();
            }
          });
          suggestionsContainer.appendChild(div);
        });
        suggestionsContainer.style.display = 'block';
      } else {
        suggestionsContainer.style.display = 'none';
      }
    }
    
    // Initializing event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const startButton = document.getElementById('start-button');
      const submitProfileButton = document.getElementById('submit-profile');
      const sendButton = document.getElementById('send-button');
      const userInput = document.getElementById('user-input');
      const welcomeScreen = document.getElementById('welcome-screen');
      const profileScreen = document.getElementById('profile-screen');
      const chatScreen = document.getElementById('chat-screen');
      const chatContainer = document.getElementById('chat-container');
      const quickButtonsContainer = document.getElementById('quick-buttons');
      const categoryButtons = document.querySelectorAll('.category-button');
      const feedbackButton = document.getElementById('feedback-button');
      const saveLogButton = document.getElementById('save-log-button');
      
      // Load persona data and chat history regardless of Google Apps Script environment
      loadPersonaData();
      const chatHistory = loadChatHistory();
      chatHistory.forEach(msg => appendMessage(msg.text, msg.type));
      
      // Handling start button click
      startButton.addEventListener('click', function() {
        console.log('Start button clicked');
        welcomeScreen.classList.add('hidden');
        profileScreen.classList.remove('hidden');
        document.getElementById('name').focus();
      });
      
      // Add keyboard support for start button
      startButton.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          console.log('Start button activated via keyboard');
          welcomeScreen.classList.add('hidden');
          profileScreen.classList.remove('hidden');
          document.getElementById('name').focus();
        }
      });
      
      // Handling profile submission
      submitProfileButton.addEventListener('click', function() {
        if (!validateProfileForm()) return;
        
        userProfile.name = document.getElementById('name').value || "ê³ ê°";
        userProfile.gender = document.getElementById('gender').value || "ë¯¸ì…ë ¥";
        userProfile.age = parseInt(document.getElementById('age').value) || 30;
        userProfile.occupation = document.getElementById('occupation').value || "ë¯¸ì…ë ¥";
        userProfile.income = parseInt(document.getElementById('income').value) || 0;
        userProfile.insuranceExperience = document.getElementById('insurance-experience').value || "ë¯¸ì…ë ¥";
        userProfile.interest = document.getElementById('interest').value || "ë¯¸ì •/ìƒë‹´í•„ìš”";
        
        // Simulate Google Apps Script save (mock for non-GAS environment)
        if (!isGoogleScriptAvailable()) {
          console.warn('Google Apps Script not detected, simulating profile save');
          profileScreen.classList.add('hidden');
          chatScreen.classList.remove('hidden');
          showTypingIndicator();
          setTimeout(function() {
            removeTypingIndicator();
            addBotMessage(`ì•ˆë…•í•˜ì„¸ìš”, ${userProfile.name}ë‹˜! í˜„ëŒ€í•´ìƒ í•˜ì´ì¼€ì–´(Hi-Care) ë´‡ì…ë‹ˆë‹¤. ìë™ì°¨ë³´í—˜ê³¼ ì‹¤ì†ì˜ë£Œë³´í—˜ì„ í¬í•¨í•œ ë§ì¶¤ ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤. ğŸ˜Š`);
            showTypingIndicator();
            setTimeout(function() {
              removeTypingIndicator();
              const matchedPersona = findMatchingPersona(userProfile);
              if (userProfile.age >= 20 && userProfile.age < 30) {
                addBotMessage("20ëŒ€ ê³ ê°ë‹˜ê»˜ëŠ” ì €ë ´í•œ ë³´í—˜ë£Œì™€ ë¹ ë¥¸ ì˜¨ë¼ì¸ ê°€ì… ìƒí’ˆì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.");
                if (matchedPersona) {
                  addBotMessage(generateRecommendation(matchedPersona));
                }
              } else if (userProfile.age >= 30 && userProfile.age < 50) {
                addBotMessage("30~40ëŒ€ ê³ ê°ë‹˜ê»˜ëŠ” ìë™ì°¨ë³´í—˜ê³¼ ì‹¤ì†ë³´í—˜ì˜ ë¹„êµ ìƒë‹´ì„ ì œê³µí•©ë‹ˆë‹¤.");
                if (matchedPersona) {
                  addBotMessage(generateRecommendation(matchedPersona));
                }
              } else {
                addBotMessage("ì•ˆì „ê³¼ ê±´ê°•ì„ ìœ„í•œ ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
              }
              updateInitialQuickButtons();
            }, Math.random() * 1000 + 1000);
          }, Math.random() * 1000 + 1000);
          return;
        }
        
        google.script.run.withSuccessHandler(function(result) {
          if (result && result.success) {
            profileScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            showTypingIndicator();
            setTimeout(function() {
              removeTypingIndicator();
              addBotMessage(`ì•ˆë…•í•˜ì„¸ìš”, ${userProfile.name}ë‹˜! í˜„ëŒ€í•´ìƒ í•˜ì´ì¼€ì–´(Hi-Care) ë´‡ì…ë‹ˆë‹¤. ìë™ì°¨ë³´í—˜ê³¼ ì‹¤ì†ì˜ë£Œë³´í—˜ì„ í¬í•¨í•œ ë§ì¶¤ ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤. ğŸ˜Š`);
              showTypingIndicator();
              setTimeout(function() {
                removeTypingIndicator();
                const matchedPersona = findMatchingPersona(userProfile);
                if (userProfile.age >= 20 && userProfile.age < 30) {
                  addBotMessage("20ëŒ€ ê³ ê°ë‹˜ê»˜ëŠ” ì €ë ´í•œ ë³´í—˜ë£Œì™€ ë¹ ë¥¸ ì˜¨ë¼ì¸ ê°€ì… ìƒí’ˆì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.");
                  if (matchedPersona) {
                    addBotMessage(generateRecommendation(matchedPersona));
                  }
                } else if (userProfile.age >= 30 && userProfile.age < 50) {
                  addBotMessage("30~40ëŒ€ ê³ ê°ë‹˜ê»˜ëŠ” ìë™ì°¨ë³´í—˜ê³¼ ì‹¤ì†ë³´í—˜ì˜ ë¹„êµ ìƒë‹´ì„ ì œê³µí•©ë‹ˆë‹¤.");
                  if (matchedPersona) {
                    addBotMessage(generateRecommendation(matchedPersona));
                  }
                } else {
                  addBotMessage("ì•ˆì „ê³¼ ê±´ê°•ì„ ìœ„í•œ ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
                }
                updateInitialQuickButtons();
              }, Math.random() * 1000 + 1000);
            }, Math.random() * 1000 + 1000);
          } else {
            addBotMessage("í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          }
        }).withFailureHandler(function(error) {
          addBotMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }).saveUserProfile(userProfile);
      });
      
      // Handling category button clicks
      categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
          const category = this.getAttribute('data-category');
          showProductInfo(category);
        });
        button.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const category = this.getAttribute('data-category');
            showProductInfo(category);
          }
        });
      });
      
      // Handling send button and enter key
      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Autocomplete for user input
      userInput.addEventListener('input', function() {
        showAutocompleteSuggestions(this.value);
      });
      
      // Hide autocomplete on blur
      userInput.addEventListener('blur', function() {
        setTimeout(() => {
          document.getElementById('autocomplete-suggestions').style.display = 'none';
        }, 200);
      });
      
      // Handling feedback button
      feedbackButton.addEventListener('click', function() {
        addBotMessage("í”¼ë“œë°±ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ìƒë‹´ì´ ë„ì›€ì´ ë˜ì—ˆëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”.");
        updateQuickButtons(["ë§¤ìš° ë§Œì¡±", "ë§Œì¡±", "ë³´í†µ", "ë¶ˆë§Œì¡±"]);
      });
      
      // Handling save log button
      saveLogButton.addEventListener('click', function() {
        saveChatLogToFile();
      });
      
      saveLogButton.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          saveChatLogToFile();
        }
      });
      
      // Sending user message
      function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
          appendMessage(message, "user");
          userInput.value = '';
          document.getElementById('autocomplete-suggestions').style.display = 'none';
          showTypingIndicator();
          if (!isGoogleScriptAvailable()) {
            removeTypingIndicator();
            addBotMessage("Google Apps Script í™˜ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œì…ë‹ˆë‹¤.");
            updateQuickButtonsByMessage(message);
            return;
          }
          google.script.run.withSuccessHandler(function(reply) {
            removeTypingIndicator();
            addBotMessage(reply);
            if (message === "ì²˜ìŒìœ¼ë¡œ") {
              resetChat();
            } else {
              updateQuickButtonsByMessage(message);
            }
          }).withFailureHandler(function(error) {
            removeTypingIndicator();
            addBotMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          }).processUserInput(message, userProfile);
        }
      }
      
      // Handling quick button clicks
      function handleQuickButtonClick(buttonText) {
        userInput.value = buttonText;
        sendMessage();
      }
      
      // Updating initial quick buttons
      function updateInitialQuickButtons() {
        const personalizedButtons = ["ìë™ì°¨ë³´í—˜ ì•ˆë‚´", "ì‹¤ì†ì˜ë£Œë³´í—˜ ì•ˆë‚´", "ë§ì¶¤ ì¶”ì²œ ë°›ê¸°", "ìƒë‹´ì‚¬ ì—°ê²°"];
        if (userProfile.interest === "ìë™ì°¨ë³´í—˜") {
          personalizedButtons.unshift("ìë™ì°¨ë³´í—˜ ê²¬ì ");
        } else if (userProfile.interest === "ì‹¤ì†ë³´í—˜") {
          personalizedButtons.unshift("ì‹¤ì†ë³´í—˜ ì•ˆë‚´");
        }
        updateQuickButtons(personalizedButtons);
      }
      
      // Updating quick buttons dynamically
      function updateQuickButtons(buttons) {
        quickButtonsContainer.innerHTML = '';
        buttons.forEach(buttonText => {
          const button = document.createElement('div');
          button.className = 'quick-button';
          button.textContent = buttonText;
          button.setAttribute('role', 'button');
          button.setAttribute('tabindex', '0');
          button.addEventListener('click', function() { handleQuickButtonClick(buttonText); });
          button.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleQuickButtonClick(buttonText);
          });
          quickButtonsContainer.appendChild(button);
        });
        // Adding "ì²˜ìŒìœ¼ë¡œ" button
        const backButton = document.createElement('div');
        backButton.className = 'quick-button';
        backButton.textContent = 'ì²˜ìŒìœ¼ë¡œ';
        backButton.setAttribute('role', 'button');
        backButton.setAttribute('tabindex', '0');
        backButton.addEventListener('click', function() { handleQuickButtonClick('ì²˜ìŒìœ¼ë¡œ'); });
        backButton.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') handleQuickButtonClick('ì²˜ìŒìœ¼ë¡œ');
        });
        quickButtonsContainer.appendChild(backButton);
      }
      
      // Updating quick buttons based on user message
      function updateQuickButtonsByMessage(message) {
        message = message.toLowerCase();
        if (message.includes('ìë™ì°¨') || message.includes('ì°¨ëŸ‰')) {
          updateQuickButtons(insuranceProducts["ìë™ì°¨ë³´í—˜"].quickButtons);
        } else if (message.includes('ì‹¤ì†') || message.includes('ì˜ë£Œ')) {
          updateQuickButtons(insuranceProducts["ì‹¤ì†ì˜ë£Œë³´í—˜"].quickButtons);
        } else if (message.includes('ì¶”ì²œ')) {
          updateQuickButtons(insuranceProducts["ì¶”ì²œìƒí’ˆ"].quickButtons);
        } else if (message.includes('ë§Œì¡±') || message.includes('ë¶ˆë§Œì¡±')) {
          updateQuickButtons(["ìë™ì°¨ë³´í—˜ ì•ˆë‚´", "ì‹¤ì†ì˜ë£Œë³´í—˜ ì•ˆë‚´", "ë§ì¶¤ ì¶”ì²œ ë°›ê¸°", "ìƒë‹´ì‚¬ ì—°ê²°"]);
          addBotMessage("í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ ë„ì™€ë“œë¦´ê¹Œìš”?");
        } else {
          updateInitialQuickButtons();
        }
      }
      
      // Resetting chat to initial state
      function resetChat() {
        chatContainer.innerHTML = '<div id="loading-indicator" class="loading-indicator hidden">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
        saveChatHistory([]);
        showTypingIndicator();
        setTimeout(function() {
          removeTypingIndicator();
          addBotMessage(`ì•ˆë…•í•˜ì„¸ìš”, ${userProfile.name}ë‹˜! í˜„ëŒ€í•´ìƒ í•˜ì´ì¼€ì–´(Hi-Care) ë´‡ì…ë‹ˆë‹¤. ìë™ì°¨ë³´í—˜ê³¼ ì‹¤ì†ì˜ë£Œë³´í—˜ì„ í¬í•¨í•œ ë§ì¶¤ ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤. ğŸ˜Š`);
          showTypingIndicator();
          setTimeout(function() {
            removeTypingIndicator();
            const matchedPersona = findMatchingPersona(userProfile);
            if (userProfile.age >= 20 && userProfile.age < 30) {
              addBotMessage("20ëŒ€ ê³ ê°ë‹˜ê»˜ëŠ” ì €ë ´í•œ ë³´í—˜ë£Œì™€ ë¹ ë¥¸ ì˜¨ë¼ì¸ ê°€ì… ìƒí’ˆì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.");
              if (matchedPersona) {
                addBotMessage(generateRecommendation(matchedPersona));
              }
            } else if (userProfile.age >= 30 && userProfile.age < 50) {
              addBotMessage("30~40ëŒ€ ê³ ê°ë‹˜ê»˜ëŠ” ìë™ì°¨ë³´í—˜ê³¼ ì‹¤ì†ë³´í—˜ì˜ ë¹„êµ ìƒë‹´ì„ ì œê³µí•©ë‹ˆë‹¤.");
              if (matchedPersona) {
                addBotMessage(generateRecommendation(matchedPersona));
              }
            } else {
              addBotMessage("ì•ˆì „ê³¼ ê±´ê°•ì„ ìœ„í•œ ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
            }
            updateInitialQuickButtons();
          }, Math.random() * 1000 + 1000);
        }, Math.random() * 1000 + 1000);
      }
      
      // Displaying product information
      function showProductInfo(category) {
        if (insuranceProducts[category]) {
          addBotMessage(`${insuranceProducts[category].description}`);
          setTimeout(() => {
            addBotMessage(`ê´€ì‹¬ ìˆëŠ” ${category}ì˜ ì„¸ë¶€ ìƒí’ˆì€ ${insuranceProducts[category].subCategories.join(', ')}ì…ë‹ˆë‹¤.`);
            updateQuickButtons(insuranceProducts[category].quickButtons);
          }, Math.random() * 500 + 500);
        }
      }
      
      // Showing typing indicator
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot typing-group';
        typingDiv.innerHTML = `
          <img src="https://i.ibb.co/D1cNQ2j/hicarebot-avatar.png" alt="bot" class="avatar" role="img" aria-label="ë´‡ ì•„ë°”íƒ€">
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>`;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      
      // Removing typing indicator
      function removeTypingIndicator() {
        const typingGroup = document.querySelector('.typing-group');
        if (typingGroup) typingGroup.remove();
      }
      
      // Adding bot message
      function addBotMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        messageDiv.innerHTML = `
          <img src="https://i.ibb.co/D1cNQ2j/hicarebot-avatar.png" alt="bot" class="avatar" role="img" aria-label="ë´‡ ì•„ë°”íƒ€">
          <div class="bubble bot">${message}</div>`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        saveChatHistory([...loadChatHistory(), { text: message, type: 'bot' }]);
      }
      
      // Adding user message
      function appendMessage(text, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `
          <img src="${type === 'bot' ? 'https://i.ibb.co/D1cNQ2j/hicarebot-avatar.png' : 'https://i.ibb.co/JBqtqtT/user-icon.png'}" alt="${type}" class="avatar" role="img" aria-label="${type === 'bot' ? 'ë´‡ ì•„ë°”íƒ€' : 'ì‚¬ìš©ì ì•„ë°”íƒ€'}">
          <div class="bubble ${type}">${text}</div>`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        if (type === 'user') {
          saveChatHistory([...loadChatHistory(), { text, type }]);
        }
      }
      
      // Warn about Google Apps Script if not available
      if (!isGoogleScriptAvailable()) {
        console.warn('Google Apps Script environment not detected. Some features may be limited.');
      }
    });
  </script>
</body>
</html>
