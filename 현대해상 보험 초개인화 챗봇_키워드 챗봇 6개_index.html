<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>현대해상 하이케어봇</title>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Pretendard:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #F9FAFB;
      color: #333;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .header {
      text-align: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .header img {
      height: 40px;
      margin-bottom: 10px;
    }
    
    .header h1 {
      color: #005BAC;
      margin: 0;
      font-size: 24px;
    }
    
    .chat-container {
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      margin: 20px 0;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }
    
    .message.bot {
      flex-direction: row;
    }
    
    .message.user {
      flex-direction: row-reverse;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .bubble {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 70%;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }
    
    .bubble.bot {
      background-color: #e1f5fe;
      color: #003c8f;
      text-align: left;
    }
    
    .bubble.user {
      background-color: #c8e6c9;
      color: #1b5e20;
      text-align: right;
      margin-left: auto;
    }
    
    .bubble.bot::after {
      content: '';
      position: absolute;
      top: 10px;
      left: -8px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid #e1f5fe;
    }
    
    .bubble.user::after {
      content: '';
      position: absolute;
      top: 10px;
      right: -8px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 8px solid #c8e6c9;
    }
    
    .input-area {
      display: flex;
      margin-top: 20px;
      justify-content: center;
      position: relative;
    }
    
    #user-input {
      flex: 1;
      max-width: 85%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
    }
    
    #user-input:focus {
      border-color: #005BAC;
      box-shadow: 0 0 5px rgba(0, 91, 172, 0.3);
    }
    
    button {
      background-color: #005BAC;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    
    button:hover {
      background-color: #004d8c;
    }
    
    button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .profile-form {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #E5E7EB;
      border-radius: 4px;
    }
    
    .form-group input:focus, .form-group select:focus {
      border-color: #005BAC;
      outline: none;
    }
    
    .form-error {
      color: #D32F2F;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    .welcome-screen {
      text-align: center;
      padding: 30px 0;
    }
    
    .welcome-screen img {
      width: 150px;
      margin-bottom: 20px;
    }
    
    .welcome-screen h2 {
      color: #005BAC;
      margin-bottom: 20px;
    }
    
    .welcome-screen p {
      margin-bottom: 30px;
      color: #666;
    }
    
    .start-button {
      background-color: #005BAC;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .start-button:hover {
      background-color: #004d8c;
    }
    
    .start-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .hidden {
      display: none;
    }
    
    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .quick-button {
      background-color: #F0F8FF;
      border: 1px solid #005BAC;
      color: #005BAC;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .quick-button:hover {
      background-color: #005BAC;
      color: white;
    }
    
    .quick-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .category-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .category-button {
      background-color: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .category-button:hover {
      border-color: #005BAC;
      box-shadow: 0 2px 8px rgba(0, 91, 172, 0.2);
    }
    
    .category-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
    
    .category-icon {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .category-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .category-desc {
      font-size: 12px;
      color: #666;
    }
    
    .typing-indicator {
      display: inline-block;
      padding: 8px 15px;
      background-color: #e1f5fe;
      border-radius: 12px;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #005BAC;
      border-radius: 50%;
      animation: typing 1s infinite;
      margin: 0 2px;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    #disclaimer {
      font-size: 10px;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
    
    .error-message {
      color: #D32F2F;
      text-align: center;
      margin: 10px 0;
    }
    
    .loading-indicator {
      text-align: center;
      margin: 10px 0;
      color: #005BAC;
      font-size: 14px;
    }
    
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .autocomplete-suggestion {
      padding: 10px;
      cursor: pointer;
      color: #333;
    }
    
    .autocomplete-suggestion:hover {
      background-color: #F0F8FF;
    }
    
    .feedback-button, .save-log-button {
      background-color: #F0F8FF;
      border: 1px solid #005BAC;
      color: #005BAC;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      margin-right: 10px;
      display: inline-block;
    }
    
    .feedback-button:hover, .save-log-button:hover {
      background-color: #005BAC;
      color: white;
    }
    
    .feedback-button:focus, .save-log-button:focus {
      outline: 2px solid #005BAC;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 시작 화면 -->
    <div id="welcome-screen" class="welcome-screen">
      <img src="https://www.hi.co.kr/images/main/logo.png" alt="현대해상 로고" role="img" aria-label="현대해상 로고">
      <h2>현대해상 하이케어(Hi-Care) 봇</h2>
      <p>고객님의 상황에 맞는 맞춤형 보험 상담을 도와드립니다.</p>
      <button id="start-button" class="start-button" role="button" aria-label="상담 시작하기">상담 시작하기</button>
    </div>
    
    <!-- 프로필 입력 화면 -->
    <div id="profile-screen" class="hidden" role="form" aria-label="고객 정보 입력 폼">
      <div class="header">
        <img src="https://www.hi.co.kr/images/main/logo.png" alt="현대해상 로고" role="img" aria-label="현대해상 로고">
        <h1>하이케어(Hi-Care)봇과 함께하는 맞춤형 상담</h1>
      </div>
      
      <div class="profile-form">
        <h2>고객 정보 입력</h2>
        <p>더 정확한 맞춤형 상담을 위해 정보를 입력해주세요.</p>
        
        <div class="form-group">
          <label for="name">이름</label>
          <input type="text" id="name" placeholder="이름을 입력하세요" aria-required="true">
          <div id="name-error" class="form-error">이름을 입력해주세요 (2~50자).</div>
        </div>
        
        <div class="form-group">
          <label for="gender">성별</label>
          <select id="gender" aria-required="true">
            <option value="">선택하세요</option>
            <option value="남성">남성</option>
            <option value="여성">여성</option>
          </select>
          <div id="gender-error" class="form-error">성별을 선택해주세요.</div>
        </div>
        
        <div class="form-group">
          <label for="age">연령</label>
          <input type="number" id="age" placeholder="나이를 입력하세요" min="18" max="100" aria-required="true">
          <div id="age-error" class="form-error">18세 이상 100세 이하의 나이를 입력해주세요.</div>
        </div>
        
        <div class="form-group">
          <label for="occupation">직업</label>
          <select id="occupation" aria-required="true">
            <option value="">선택하세요</option>
            <option value="사무직">사무직</option>
            <option value="전문직">전문직</option>
            <option value="자영업">자영업</option>
            <option value="학생">학생</option>
            <option value="기타">기타</option>
          </select>
          <div id="occupation-error" class="form-error">직업을 선택해주세요.</div>
        </div>
        
        <div class="form-group">
          <label for="income">연소득 (만 원)</label>
          <select id="income">
            <option value="">선택하세요</option>
            <option value="100">3000이하</option>
            <option value="300">3000이상 ~ 5000미만</option>
            <option value="500">5000이상 ~ 7000미만</option>
            <option value="1000">7000이상</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="insurance-experience">보험 가입 경험</label>
          <select id="insurance-experience">
            <option value="">선택하세요</option>
            <option value="없음">없음</option>
            <option value="자동차보험만">자동차보험만</option>
            <option value="실손보험만">실손보험만</option>
            <option value="다양한 보험 가입">다양한 보험 가입</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="interest">관심 있는 보험 상품</label>
          <select id="interest">
            <option value="">선택하세요</option>
            <option value="자동차보험">자동차보험</option>
            <option value="실손보험">실손보험</option>
            <option value="미정/상담필요">미정/상담필요</option>
          </select>
        </div>
        
        <button id="submit-profile" role="button" aria-label="상담 시작하기">상담 시작하기</button>
      </div>
    </div>
    
    <!-- 챗봇 화면 -->
    <div id="chat-screen" class="hidden" role="region" aria-label="챗봇 대화 화면">
      <div class="header">
        <img src="https://www.hi.co.kr/images/main/logo.png" alt="현대해상 로고" role="img" aria-label="현대해상 로고">
        <h1>하이케어(Hi-Care) 봇</h1>
      </div>
      
      <div id="chat-container" class="chat-container" role="log" aria-live="polite">
        <!-- 메시지가 여기에 동적으로 추가됩니다 -->
        <div id="loading-indicator" class="loading-indicator hidden">데이터를 불러오는 중입니다...</div>
      </div>
      
      <!-- 카테고리 버튼 영역 -->
      <div id="category-buttons" class="category-buttons" role="navigation" aria-label="보험 카테고리 선택">
        <div class="category-button" data-category="자동차보험" role="button" tabindex="0" aria-label="자동차보험: 자동차/이륜차/운전자">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_car.png');"></div>
          <div class="category-title">자동차보험</div>
          <div class="category-desc">자동차/이륜차/운전자</div>
        </div>
        <div class="category-button" data-category="실손의료보험" role="button" tabindex="0" aria-label="실손의료보험: 실손/건강">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_health.png');"></div>
          <div class="category-title">실손의료보험</div>
          <div class="category-desc">실손/건강</div>
        </div>
        <div class="category-button" data-category="상담예약" role="button" tabindex="0" aria-label="상담예약: 전화/화상 상담">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_consult.png');"></div>
          <div class="category-title">상담예약</div>
          <div class="category-desc">전화/화상 상담</div>
        </div>
        <div class="category-button" data-category="보험료계산" role="button" tabindex="0" aria-label="보험료계산: 견적 확인">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_calculate.png');"></div>
          <div class="category-title">보험료계산</div>
          <div class="category-desc">견적 확인</div>
        </div>
        <div class="category-button" data-category="추천상품" role="button" tabindex="0" aria-label="추천상품: 맞춤 추천">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_recommend.png');"></div>
          <div class="category-title">추천상품</div>
          <div class="category-desc">맞춤 추천</div>
        </div>
        <div class="category-button" data-category="지점안내" role="button" tabindex="0" aria-label="지점안내: 최근 지점">
          <div class="category-icon" style="background-image: url('https://www.hi.co.kr/images/main/icon_location.png');"></div>
          <div class="category-title">지점안내</div>
          <div class="category-desc">최근 지점</div>
        </div>
      </div>
      
      <!-- 퀵버튼 영역 -->
      <div id="quick-buttons" class="quick-buttons" role="navigation" aria-label="빠른 응답 버튼">
        <!-- 퀵버튼은 동적으로 추가됩니다 -->
      </div>
      
      <div class="input-area">
        <input type="text" id="user-input" placeholder="메시지를 입력하세요..." role="textbox" aria-label="메시지 입력" autocomplete="off">
        <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
        <button id="send-button" role="button" aria-label="메시지 보내기">보내기</button>
      </div>
      
      <button id="feedback-button" class="feedback-button" role="button" aria-label="피드백 제공">피드백 제공</button>
      <button id="save-log-button" class="save-log-button" role="button" aria-label="대화 로그 저장">대화 로그 저장</button>
    </div>
    
    <div id="disclaimer">법적 구속력 없는 정보로, 상담원 확인 권장</div>
  </div>

  <script>
    // Initializing user profile
    let userProfile = {
      name: "",
      gender: "",
      age: 0,
      occupation: "",
      income: 0,
      insuranceExperience: "",
      interest: ""
    };
    
    // Defining insurance products
    const insuranceProducts = {
      "자동차보험": {
        description: "자동차 사고로 인한 손해를 보상하는 상품입니다.",
        subCategories: ["자동차보험", "이륜차보험", "운전자보험"],
        quickButtons: ["자동차보험 견적", "이륜차보험 안내", "운전자보험 상담"]
      },
      "실손의료보험": {
        description: "의료비를 보장하는 실손의료보험 상품입니다.",
        subCategories: ["실손보험", "건강보험"],
        quickButtons: ["실손보험 안내", "건강보험 상담"]
      },
      "상담예약": {
        description: "전화 또는 화상 상담 예약 서비스입니다.",
        subCategories: ["전화 상담", "화상 상담"],
        quickButtons: ["전화 상담 예약", "화상 상담 예약"]
      },
      "보험료계산": {
        description: "보험료 견적을 확인할 수 있습니다.",
        subCategories: ["자동차보험 견적", "실손보험 견적"],
        quickButtons: ["자동차보험 견적", "실손보험 견적"]
      },
      "추천상품": {
        description: "고객님께 맞는 보험 상품을 추천합니다.",
        subCategories: ["맞춤 추천", "가족 보험"],
        quickButtons: ["맞춤 추천 받기", "가족 보험 안내"]
      },
      "지점안내": {
        description: "가까운 지점 정보를 제공합니다.",
        subCategories: ["지점 위치", "방문 예약"],
        quickButtons: ["지점 위치 안내", "방문 예약"]
      }
    };
    
    // Storing persona data
    let personaData = [];
    
    // Autocomplete suggestions
    const autocompleteSuggestions = [
      "자동차보험 견적",
      "실손보험 안내",
      "맞춤 추천 받기",
      "상담사 연결",
      "보험료 계산",
      "지점 위치",
      "운전자보험 상담",
      "건강보험 상담"
    ];
    
    // Loading and parsing persona CSV
    function loadPersonaData() {
      const loadingIndicator = document.getElementById('loading-indicator');
      loadingIndicator.classList.remove('hidden');
      Papa.parse(loadFileData("고객페르소나.csv"), {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        transformHeader: header => header.trim().replace(/^"|"$/g, ''),
        transform: (value, header) => {
          let cleaned = value.trim().replace(/^"|"$/g, '');
          return cleaned;
        },
        complete: results => {
          personaData = results.data.map(row => ({
            id: row["ID"],
            name: row["페르소나명"],
            ageGroup: row["연령대"],
            gender: row["성별"],
            occupation: row["직업"],
            residence: row["거주지"],
            vehicle: row["차량 정보"],
            drivingExperience: row["운전 경력"],
            family: row["가족 구성"],
            currentProduct: row["현재 가입 상품 (현대해상)"],
            specialClauses: row["주요 특약 (현대해상 다이렉트 기준)"],
            monthlyPremium: parseFloat(row["월 평균 보험료 (추정)"]?.replace("만원", "") || 0),
            drivingPattern: row["주요 주행 패턴"],
            drivingHabit: row["운전 습관"],
            infoChannel: row["정보 탐색 채널"],
            coreNeeds: row["핵심 니즈"],
            painPoints: row["페인 포인트"],
            preferenceReason: row["현대해상 다이렉트 선호 이유/기대"]
          }));
          loadingIndicator.classList.add('hidden');
        },
        error: err => {
          console.error("CSV parsing error:", err);
          loadingIndicator.classList.add('hidden');
          addBotMessage("데이터 로딩 중 오류가 발생했습니다. 다시 시도해주세요.");
        }
      });
    }
    
    // Matching user to closest persona
    function findMatchingPersona(profile) {
      if (!profile || !profile.age || !profile.gender || !profile.occupation) {
        return null;
      }
      
      const age = parseInt(profile.age);
      const ageGroup = age >= 20 && age < 30 ? "20대" : age >= 30 && age < 50 ? "30대" : "40대";
      let bestMatch = null;
      let highestScore = 0;
      
      personaData.forEach(persona => {
        let score = 0;
        if (persona.ageGroup === ageGroup) score += 3;
        if (persona.gender === profile.gender) score += 2;
        if (persona.occupation.toLowerCase().includes(profile.occupation.toLowerCase())) score += 2;
        if (profile.interest === "자동차보험" && persona.currentProduct.includes("자동차보험")) score += 1;
        if (profile.interest === "실손보험" && !persona.currentProduct.includes("자동차보험")) score += 1;
        
        if (score > highestScore) {
          highestScore = score;
          bestMatch = persona;
        }
      });
      
      return bestMatch;
    }
    
    // Generating personalized recommendation
    function generateRecommendation(persona) {
      if (!persona) {
        return "고객님의 정보를 기반으로 적합한 보험 상품을 찾을 수 없습니다. 더 자세한 정보를 입력해 주세요.";
      }
      
      return `고객님께 추천드리는 상품은 ${persona.currentProduct}입니다.  
주요 특약: ${persona.specialClauses}  
추정 월 보험료: ${persona.monthlyPremium}만원  
고객님의 운전 패턴(${persona.drivingPattern})과 니즈(${persona.coreNeeds})에 적합하며, ${persona.preferenceReason}을 제공합니다.`;
    }
    
    // Mock function to simulate file loading
    function loadFileData(fileName) {
      return "ID,페르소나명,연령대,성별,직업,거주지,차량 정보,운전 경력,가족 구성,현재 가입 상품 (현대해상),주요 특약 (현대해상 다이렉트 기준),월 평균 보험료 (추정),주요 주행 패턴,운전 습관,정보 탐색 채널,핵심 니즈,페인 포인트,현대해상 다이렉트 선호 이유/기대\n1,김지영,30대,여성,사무직,서울,소형 SUV,5년,2인 가족,자동차보험,대인배상/대물배상,5만원,도심 주행,안전운전,온라인,합리적인 보험료,복잡한 가입 절차,간편한 온라인 가입";
    }
    
    // Check for Google Apps Script environment
    function isGoogleScriptAvailable() {
      return typeof google !== 'undefined' && google.script && google.script.run;
    }
    
    // Save chat history to localStorage
    function saveChatHistory(messages) {
      localStorage.setItem('hicareBotChat', JSON.stringify(messages));
    }
    
    // Load chat history from localStorage
    function loadChatHistory() {
      const saved = localStorage.getItem('hicareBotChat');
      return saved ? JSON.parse(saved) : [];
    }
    
    // Save chat log to a text file
    function saveChatLogToFile() {
      const chatHistory = loadChatHistory();
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `hicarebot_chatlog_${timestamp}.txt`;
      let logContent = `현대해상 하이케어(Hi-Care) 봇 대화 로그\n생성일: ${new Date().toLocaleString('ko-KR')}\n사용자: ${userProfile.name || '익명'}\n\n`;
      
      chatHistory.forEach(msg => {
        const sender = msg.type === 'bot' ? '하이케어봇' : '사용자';
        logContent += `[${sender}]: ${msg.text}\n`;
      });
      
      const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      addBotMessage("대화 로그가 성공적으로 저장되었습니다.");
    }
    
    // Validate profile form
    function validateProfileForm() {
      let isValid = true;
      const name = document.getElementById('name').value.trim();
      const gender = document.getElementById('gender').value;
      const age = parseInt(document.getElementById('age').value);
      const occupation = document.getElementById('occupation').value;
      
      const nameError = document.getElementById('name-error');
      const genderError = document.getElementById('gender-error');
      const ageError = document.getElementById('age-error');
      const occupationError = document.getElementById('occupation-error');
      
      nameError.style.display = 'none';
      genderError.style.display = 'none';
      ageError.style.display = 'none';
      occupationError.style.display = 'none';
      
      if (!name || name.length < 2 || name.length > 50) {
        nameError.style.display = 'block';
        isValid = false;
      }
      
      if (!gender) {
        genderError.style.display = 'block';
        isValid = false;
      }
      
      if (isNaN(age) || age < 18 || age > 100) {
        ageError.style.display = 'block';
        isValid = false;
      }
      
      if (!occupation) {
        occupationError.style.display = 'block';
        isValid = false;
      }
      
      return isValid;
    }
    
    // Show autocomplete suggestions
    function showAutocompleteSuggestions(input) {
      const suggestionsContainer = document.getElementById('autocomplete-suggestions');
      suggestionsContainer.innerHTML = '';
      if (!input) {
        suggestionsContainer.style.display = 'none';
        return;
      }
      
      const filteredSuggestions = autocompleteSuggestions.filter(s =>
        s.toLowerCase().includes(input.toLowerCase())
      );
      
      if (filteredSuggestions.length > 0) {
        filteredSuggestions.forEach(suggestion => {
          const div = document.createElement('div');
          div.className = 'autocomplete-suggestion';
          div.textContent = suggestion;
          div.setAttribute('role', 'option');
          div.setAttribute('tabindex', '0');
          div.addEventListener('click', () => {
            document.getElementById('user-input').value = suggestion;
            suggestionsContainer.style.display = 'none';
            sendMessage();
          });
          div.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              document.getElementById('user-input').value = suggestion;
              suggestionsContainer.style.display = 'none';
              sendMessage();
            }
          });
          suggestionsContainer.appendChild(div);
        });
        suggestionsContainer.style.display = 'block';
      } else {
        suggestionsContainer.style.display = 'none';
      }
    }
    
    // Initializing event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const startButton = document.getElementById('start-button');
      const submitProfileButton = document.getElementById('submit-profile');
      const sendButton = document.getElementById('send-button');
      const userInput = document.getElementById('user-input');
      const welcomeScreen = document.getElementById('welcome-screen');
      const profileScreen = document.getElementById('profile-screen');
      const chatScreen = document.getElementById('chat-screen');
      const chatContainer = document.getElementById('chat-container');
      const quickButtonsContainer = document.getElementById('quick-buttons');
      const categoryButtons = document.querySelectorAll('.category-button');
      const feedbackButton = document.getElementById('feedback-button');
      const saveLogButton = document.getElementById('save-log-button');
      
      // Load persona data and chat history regardless of Google Apps Script environment
      loadPersonaData();
      const chatHistory = loadChatHistory();
      chatHistory.forEach(msg => appendMessage(msg.text, msg.type));
      
      // Handling start button click
      startButton.addEventListener('click', function() {
        console.log('Start button clicked');
        welcomeScreen.classList.add('hidden');
        profileScreen.classList.remove('hidden');
        document.getElementById('name').focus();
      });
      
      // Add keyboard support for start button
      startButton.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          console.log('Start button activated via keyboard');
          welcomeScreen.classList.add('hidden');
          profileScreen.classList.remove('hidden');
          document.getElementById('name').focus();
        }
      });
      
      // Handling profile submission
      submitProfileButton.addEventListener('click', function() {
        if (!validateProfileForm()) return;
        
        userProfile.name = document.getElementById('name').value || "고객";
        userProfile.gender = document.getElementById('gender').value || "미입력";
        userProfile.age = parseInt(document.getElementById('age').value) || 30;
        userProfile.occupation = document.getElementById('occupation').value || "미입력";
        userProfile.income = parseInt(document.getElementById('income').value) || 0;
        userProfile.insuranceExperience = document.getElementById('insurance-experience').value || "미입력";
        userProfile.interest = document.getElementById('interest').value || "미정/상담필요";
        
        // Simulate Google Apps Script save (mock for non-GAS environment)
        if (!isGoogleScriptAvailable()) {
          console.warn('Google Apps Script not detected, simulating profile save');
          profileScreen.classList.add('hidden');
          chatScreen.classList.remove('hidden');
          showTypingIndicator();
          setTimeout(function() {
            removeTypingIndicator();
            addBotMessage(`안녕하세요, ${userProfile.name}님! 현대해상 하이케어(Hi-Care) 봇입니다. 자동차보험과 실손의료보험을 포함한 맞춤 상담을 시작합니다. 😊`);
            showTypingIndicator();
            setTimeout(function() {
              removeTypingIndicator();
              const matchedPersona = findMatchingPersona(userProfile);
              if (userProfile.age >= 20 && userProfile.age < 30) {
                addBotMessage("20대 고객님께는 저렴한 보험료와 빠른 온라인 가입 상품을 추천드립니다.");
                if (matchedPersona) {
                  addBotMessage(generateRecommendation(matchedPersona));
                }
              } else if (userProfile.age >= 30 && userProfile.age < 50) {
                addBotMessage("30~40대 고객님께는 자동차보험과 실손보험의 비교 상담을 제공합니다.");
                if (matchedPersona) {
                  addBotMessage(generateRecommendation(matchedPersona));
                }
              } else {
                addBotMessage("안전과 건강을 위한 상담을 도와드리겠습니다.");
              }
              updateInitialQuickButtons();
            }, Math.random() * 1000 + 1000);
          }, Math.random() * 1000 + 1000);
          return;
        }
        
        google.script.run.withSuccessHandler(function(result) {
          if (result && result.success) {
            profileScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            showTypingIndicator();
            setTimeout(function() {
              removeTypingIndicator();
              addBotMessage(`안녕하세요, ${userProfile.name}님! 현대해상 하이케어(Hi-Care) 봇입니다. 자동차보험과 실손의료보험을 포함한 맞춤 상담을 시작합니다. 😊`);
              showTypingIndicator();
              setTimeout(function() {
                removeTypingIndicator();
                const matchedPersona = findMatchingPersona(userProfile);
                if (userProfile.age >= 20 && userProfile.age < 30) {
                  addBotMessage("20대 고객님께는 저렴한 보험료와 빠른 온라인 가입 상품을 추천드립니다.");
                  if (matchedPersona) {
                    addBotMessage(generateRecommendation(matchedPersona));
                  }
                } else if (userProfile.age >= 30 && userProfile.age < 50) {
                  addBotMessage("30~40대 고객님께는 자동차보험과 실손보험의 비교 상담을 제공합니다.");
                  if (matchedPersona) {
                    addBotMessage(generateRecommendation(matchedPersona));
                  }
                } else {
                  addBotMessage("안전과 건강을 위한 상담을 도와드리겠습니다.");
                }
                updateInitialQuickButtons();
              }, Math.random() * 1000 + 1000);
            }, Math.random() * 1000 + 1000);
          } else {
            addBotMessage("프로필 저장에 실패했습니다. 다시 시도해주세요.");
          }
        }).withFailureHandler(function(error) {
          addBotMessage("오류가 발생했습니다: " + error.message);
        }).saveUserProfile(userProfile);
      });
      
      // Handling category button clicks
      categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
          const category = this.getAttribute('data-category');
          showProductInfo(category);
        });
        button.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const category = this.getAttribute('data-category');
            showProductInfo(category);
          }
        });
      });
      
      // Handling send button and enter key
      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Autocomplete for user input
      userInput.addEventListener('input', function() {
        showAutocompleteSuggestions(this.value);
      });
      
      // Hide autocomplete on blur
      userInput.addEventListener('blur', function() {
        setTimeout(() => {
          document.getElementById('autocomplete-suggestions').style.display = 'none';
        }, 200);
      });
      
      // Handling feedback button
      feedbackButton.addEventListener('click', function() {
        addBotMessage("피드백을 주셔서 감사합니다! 상담이 도움이 되었는지 알려주세요.");
        updateQuickButtons(["매우 만족", "만족", "보통", "불만족"]);
      });
      
      // Handling save log button
      saveLogButton.addEventListener('click', function() {
        saveChatLogToFile();
      });
      
      saveLogButton.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          saveChatLogToFile();
        }
      });
      
      // Sending user message
      function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
          appendMessage(message, "user");
          userInput.value = '';
          document.getElementById('autocomplete-suggestions').style.display = 'none';
          showTypingIndicator();
          if (!isGoogleScriptAvailable()) {
            removeTypingIndicator();
            addBotMessage("Google Apps Script 환경이 필요합니다. 현재는 테스트 모드입니다.");
            updateQuickButtonsByMessage(message);
            return;
          }
          google.script.run.withSuccessHandler(function(reply) {
            removeTypingIndicator();
            addBotMessage(reply);
            if (message === "처음으로") {
              resetChat();
            } else {
              updateQuickButtonsByMessage(message);
            }
          }).withFailureHandler(function(error) {
            removeTypingIndicator();
            addBotMessage("오류가 발생했습니다: " + error.message);
          }).processUserInput(message, userProfile);
        }
      }
      
      // Handling quick button clicks
      function handleQuickButtonClick(buttonText) {
        userInput.value = buttonText;
        sendMessage();
      }
      
      // Updating initial quick buttons
      function updateInitialQuickButtons() {
        const personalizedButtons = ["자동차보험 안내", "실손의료보험 안내", "맞춤 추천 받기", "상담사 연결"];
        if (userProfile.interest === "자동차보험") {
          personalizedButtons.unshift("자동차보험 견적");
        } else if (userProfile.interest === "실손보험") {
          personalizedButtons.unshift("실손보험 안내");
        }
        updateQuickButtons(personalizedButtons);
      }
      
      // Updating quick buttons dynamically
      function updateQuickButtons(buttons) {
        quickButtonsContainer.innerHTML = '';
        buttons.forEach(buttonText => {
          const button = document.createElement('div');
          button.className = 'quick-button';
          button.textContent = buttonText;
          button.setAttribute('role', 'button');
          button.setAttribute('tabindex', '0');
          button.addEventListener('click', function() { handleQuickButtonClick(buttonText); });
          button.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleQuickButtonClick(buttonText);
          });
          quickButtonsContainer.appendChild(button);
        });
        // Adding "처음으로" button
        const backButton = document.createElement('div');
        backButton.className = 'quick-button';
        backButton.textContent = '처음으로';
        backButton.setAttribute('role', 'button');
        backButton.setAttribute('tabindex', '0');
        backButton.addEventListener('click', function() { handleQuickButtonClick('처음으로'); });
        backButton.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') handleQuickButtonClick('처음으로');
        });
        quickButtonsContainer.appendChild(backButton);
      }
      
      // Updating quick buttons based on user message
      function updateQuickButtonsByMessage(message) {
        message = message.toLowerCase();
        if (message.includes('자동차') || message.includes('차량')) {
          updateQuickButtons(insuranceProducts["자동차보험"].quickButtons);
        } else if (message.includes('실손') || message.includes('의료')) {
          updateQuickButtons(insuranceProducts["실손의료보험"].quickButtons);
        } else if (message.includes('추천')) {
          updateQuickButtons(insuranceProducts["추천상품"].quickButtons);
        } else if (message.includes('만족') || message.includes('불만족')) {
          updateQuickButtons(["자동차보험 안내", "실손의료보험 안내", "맞춤 추천 받기", "상담사 연결"]);
          addBotMessage("피드백이 저장되었습니다. 추가로 도와드릴까요?");
        } else {
          updateInitialQuickButtons();
        }
      }
      
      // Resetting chat to initial state
      function resetChat() {
        chatContainer.innerHTML = '<div id="loading-indicator" class="loading-indicator hidden">데이터를 불러오는 중입니다...</div>';
        saveChatHistory([]);
        showTypingIndicator();
        setTimeout(function() {
          removeTypingIndicator();
          addBotMessage(`안녕하세요, ${userProfile.name}님! 현대해상 하이케어(Hi-Care) 봇입니다. 자동차보험과 실손의료보험을 포함한 맞춤 상담을 시작합니다. 😊`);
          showTypingIndicator();
          setTimeout(function() {
            removeTypingIndicator();
            const matchedPersona = findMatchingPersona(userProfile);
            if (userProfile.age >= 20 && userProfile.age < 30) {
              addBotMessage("20대 고객님께는 저렴한 보험료와 빠른 온라인 가입 상품을 추천드립니다.");
              if (matchedPersona) {
                addBotMessage(generateRecommendation(matchedPersona));
              }
            } else if (userProfile.age >= 30 && userProfile.age < 50) {
              addBotMessage("30~40대 고객님께는 자동차보험과 실손보험의 비교 상담을 제공합니다.");
              if (matchedPersona) {
                addBotMessage(generateRecommendation(matchedPersona));
              }
            } else {
              addBotMessage("안전과 건강을 위한 상담을 도와드리겠습니다.");
            }
            updateInitialQuickButtons();
          }, Math.random() * 1000 + 1000);
        }, Math.random() * 1000 + 1000);
      }
      
      // Displaying product information
      function showProductInfo(category) {
        if (insuranceProducts[category]) {
          addBotMessage(`${insuranceProducts[category].description}`);
          setTimeout(() => {
            addBotMessage(`관심 있는 ${category}의 세부 상품은 ${insuranceProducts[category].subCategories.join(', ')}입니다.`);
            updateQuickButtons(insuranceProducts[category].quickButtons);
          }, Math.random() * 500 + 500);
        }
      }
      
      // Showing typing indicator
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot typing-group';
        typingDiv.innerHTML = `
          <img src="https://i.ibb.co/D1cNQ2j/hicarebot-avatar.png" alt="bot" class="avatar" role="img" aria-label="봇 아바타">
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>`;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      
      // Removing typing indicator
      function removeTypingIndicator() {
        const typingGroup = document.querySelector('.typing-group');
        if (typingGroup) typingGroup.remove();
      }
      
      // Adding bot message
      function addBotMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        messageDiv.innerHTML = `
          <img src="https://i.ibb.co/D1cNQ2j/hicarebot-avatar.png" alt="bot" class="avatar" role="img" aria-label="봇 아바타">
          <div class="bubble bot">${message}</div>`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        saveChatHistory([...loadChatHistory(), { text: message, type: 'bot' }]);
      }
      
      // Adding user message
      function appendMessage(text, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `
          <img src="${type === 'bot' ? 'https://i.ibb.co/D1cNQ2j/hicarebot-avatar.png' : 'https://i.ibb.co/JBqtqtT/user-icon.png'}" alt="${type}" class="avatar" role="img" aria-label="${type === 'bot' ? '봇 아바타' : '사용자 아바타'}">
          <div class="bubble ${type}">${text}</div>`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        if (type === 'user') {
          saveChatHistory([...loadChatHistory(), { text, type }]);
        }
      }
      
      // Warn about Google Apps Script if not available
      if (!isGoogleScriptAvailable()) {
        console.warn('Google Apps Script environment not detected. Some features may be limited.');
      }
    });
  </script>
</body>
</html>
